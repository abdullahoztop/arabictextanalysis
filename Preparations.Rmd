---
title: "doha"
output:
  html_document: default
  word_document: default
  keep_md: true
---

```{r message=FALSE, warning=FALSE}

library(tidyverse)
library(readOffice)
library(tidytext)
library(readxl)
library(arabicStemR)
library(plotly)


stop <- read_excel("stops_.xlsx")
fenar.raw <- read_docx("fenar.docx")
husam.raw <- read_docx("husam.docx")

fenar.regulated <-  str_c(fenar.raw,collapse=' ')
husam.regulated <-  str_c(husam.raw,collapse=' ')

 fenar.cleaned <- fenar.regulated %>% 
  cleanChars() %>% 
  fixAlifs() %>% 
  removeDiacritics() %>% 
  removePunctuation() %>% 
  removeNumbers() %>% 
  cleanLatinChars() %>% 
  removeNewlineChars()
 
  husam.cleaned <- husam.regulated %>% 
  cleanChars() %>% 
  fixAlifs() %>% 
  removeDiacritics() %>% 
  removePunctuation() %>% 
  removeNumbers() %>% 
  cleanLatinChars() %>% 
  removeNewlineChars()

fenar.frame <- data_frame(Book = "Fenari", fenar.cleaned = fenar.cleaned)
husam.frame <- data_frame(Book = "Husam", husam.cleaned = husam.cleaned)

fenar <- fenar.frame %>% unnest_tokens(word, fenar.cleaned)
husam <- husam.frame %>% unnest_tokens(word, husam.cleaned)

merged <- bind_rows(fenar, husam)

merged1 <- merged %>% anti_join(stop)


book_words <- merged1 %>% count(Book, word, sort = TRUE) %>% ungroup()

total_words <- book_words %>% group_by(Book) %>% summarize(total = sum(n))

book_words <- left_join(book_words, total_words)

book_words

ggplot(book_words, aes(n/total, fill = Book)) + geom_histogram(show.legend = FALSE) + xlim(NA, 0.008) +
facet_wrap(~Book, ncol = 2, scales = "free_y")

freq_by_rank <- book_words %>% group_by(Book) %>% mutate(rank = row_number(),
`term frequency` = n/total) 

freq_by_rank


freq_by_rank %>%
ggplot(aes(rank, `term frequency`, color = Book)) + geom_line(size = 1.1, alpha = 0.8, show.legend = T) + scale_x_log10() +
scale_y_log10()


rank_subset <- freq_by_rank %>% filter(rank < 500,
rank > 10)
lm(log10(`term frequency`) ~ log10(rank), data = rank_subset)

freq_by_rank %>%
ggplot(aes(rank, `term frequency`, color = Book)) +
geom_abline(intercept = -1.46, slope = -0.66  , color = "gray50", linetype = 2) + geom_line(size = 1.1, alpha = 0.8, show.legend = T) +
scale_x_log10() +
scale_y_log10()


book_words1 <- book_words %>% bind_tf_idf(word, Book, n)
book_words1


book_words1 %>% select(-total) %>% arrange(desc(tf_idf))


plot <- book_words1 %>%
arrange(desc(tf_idf)) %>%
mutate(word = factor(word, levels = rev(unique(word)))) %>% group_by(Book) %>%
top_n(20) %>%
ungroup %>%
ggplot(aes(word, tf_idf, fill = Book)) + geom_col(show.legend = FALSE) +
labs(x = NULL, y = "tf-idf") +
facet_wrap(~Book, ncol = 2, scales = "free") + coord_flip()

ggplotly(plot)





```
